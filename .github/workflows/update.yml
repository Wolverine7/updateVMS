name: Update and reboot VMs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-and-reboot:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        host: ["35.173.30.185"]
    
    steps:
      - name: SSH into VM and update
        uses: appleboy/ssh-action@master
        with:
          host: ${{ matrix.host }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            if yum list updates | grep -q -v "^$"; then
              sudo yum update -y
            else
              echo "No updates available"
            fi
            if sudo rpm -qa | grep kernel | grep -v `uname -r`; then
              sudo rpm -qa | grep kernel | grep -v `uname -r` | xargs sudo yum -y remove
            else
              echo "No old kernels to remove"  
            fi
      
      - name: Reboot VM
        uses: appleboy/ssh-action@master
        if: always()
        with:
          host: ${{ matrix.host }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            echo "Rebooting the machine..."
            expect -c 'spawn ssh $env(USERNAME)@$env(HOST) sudo reboot; expect "*?assword:*"; send -- "$env(PASSWORD)\r"; interact;'
      
      - name: Wait for VM to come back
        uses: appleboy/ssh-action@master
        with:
          host: ${{ matrix.host }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            echo "Waiting for VM to come back..."
            until nc -z -v -w5 ${{ matrix.host }} 22; do sleep 5; done
            echo "Success: VM is back up and running"